<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sachin Deep Cleaning</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- OneSignal Push Notification Integration START -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  try {
    await OneSignal.init({
      appId: "ed4eb090-75aa-4d2c-b321-183eb734f389",
      safari_web_id: "web.onesignal.auto.477dedc8-8bcf-40fd-b64c-238033111672",
      notifyButton: { 
        enable: true, // ✅ Always enable the OneSignal bell
        position: 'bottom-left',
        theme: 'default',
        size: 'medium',
        offset: {
          bottom: '20px',
          left: '20px'
        },
        colors: {
          'circle.background': '#ff9800',
          'circle.foreground': 'white',
          'badge.background': '#ff9800',
          'badge.foreground': 'white',
          'dialog.button.background.hovering': '#ff9800',
          'dialog.button.background.active': '#ff9800',
          'dialog.button.foreground': 'white'
        },
        text: {
          'tip.state.unsubscribed': 'Get notified about cleaning offers',
          'tip.state.subscribed': "You're subscribed to notifications",
          'tip.state.blocked': "You've blocked notifications",
          'message.prenotify': 'Click to get notified about cleaning services and offers',
          'message.action.subscribed': "Thanks! You'll receive notifications about our cleaning services",
          'message.action.resubscribed': "You're subscribed to our cleaning service notifications",
          'dialog.main.title': 'Manage Site Notifications',
          'dialog.main.button.subscribe': 'Allow Notifications',
          'dialog.main.button.unsubscribe': 'Block Notifications',
          'dialog.blocked.title': 'Unblock Notifications',
          'dialog.blocked.message': "Follow these instructions to allow notifications:"
        }
      },
      serviceWorkerParam: { scope: '/onesignal/' },
      serviceWorkerPath: 'OneSignalSDKWorker.js'
    });

    // Optional: Hide your custom button if the OneSignal bell is active
    const customNotifyBtn = document.getElementById("notifyBtn");
    if (customNotifyBtn) {
      customNotifyBtn.style.display = 'none';
    }

  } catch (err) {
    console.warn('OneSignal initialization failed:', err);
    // Show custom button as fallback
    const customNotifyBtn = document.getElementById("notifyBtn");
    if (customNotifyBtn) {
      customNotifyBtn.style.display = 'flex';
    }
  }
});
</script>
<!-- OneSignal Push Notification Integration END -->
  <style>
    body { font-family: Arial, sans-serif; }
    .hero {
      background: url('https://aonedeepcleaning.in/assets/img/cleaning/slide3.jpg') no-repeat center center;
      background-size: cover;
      color: white;
      padding: 100px 0;
      text-align: center;
    }
    .services .card { transition: 0.3s ease; }
    .services .card:hover { transform: scale(1.05); }
    footer { background: #222; color: #aaa; padding: 20px 0; text-align: center; }
    .floating-button {
      position: fixed;
      bottom: 20px;
      z-index: 1000;
      width: 50px;
      height: 50px;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      text-decoration: none;
    }
    
    /* Spinner Styling */
    #spinner {
      display: none;
      margin: 20px auto;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
   
    /* Right side buttons */
    .call-button {
      right: 20px;
      bottom: 90px;
      background-color: #007bff;
    }
    .whatsapp-button {
      right: 20px;
      bottom: 20px;
      background-color: #25d366;
    }

    /* Left side buttons */
    #installBtn {
      display: none;
      align-items: center;
      justify-content: center;
      position: fixed;
      bottom: 90px;
      left: 20px;
      z-index: 1100;
      background-color: #007bff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    .notification-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: #ff9800;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: white;
      font-size: 22px;
      cursor: pointer;
      display: none; /* Hidden by default, shown only if OneSignal fails */
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    /* Reviews Section */
    #reviews {
      background: #f8f9fa;
      padding: 60px 15px;
      text-align: center;
    }
    #reviews h2 {
      margin-bottom: 40px;
      font-weight: 700;
      color: #007bff;
    }
    #reviewSlider {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 0 auto;
    }
    .review-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1 1 calc(33.333% - 20px);
      min-width: 280px;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: left;
    }
    .review-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      gap: 15px;
      width: 100%;
    }
    .avatar-placeholder {
      border-radius: 50%;
      width: 50px;
      height: 50px;
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      border: 2px solid #007bff;
    }
    .reviewer-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0;
    }
    .reviewer-location {
      font-size: 0.9rem;
      color: #555;
    }
    .review-text {
      font-style: italic;
      margin-bottom: 15px;
      flex-grow: 1;
      color: #333;
    }
    .star-rating {
      color: #f8ce0b;
      font-size: 1.2rem;
      text-align: center;
    }

    @media(max-width: 768px) {
      .review-card {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }

    /* iOS PWA Notification Banner */
    #ios-notification-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-size: 14px;
      z-index: 2000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    #ios-notification-banner.show {
      transform: translateY(0);
    }
    #ios-notification-banner .close-banner {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    #ios-notification-banner a {
      color: white;
      text-decoration: underline;
      cursor: pointer;
    }
    
    /* Better mobile experience */
    @media(max-width: 480px) {
      #ios-notification-banner {
        font-size: 13px;
        padding: 10px 40px 10px 15px;
      }
    }

    /* iOS Instructions Modal */
    #ios-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    #ios-modal.show {
      display: flex;
    }
    .ios-modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px 25px;
      margin: 20px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .ios-modal-content h3 {
      color: #007bff;
      margin-bottom: 20px;
    }
    .ios-modal-content .step {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      text-align: left;
    }
    .ios-modal-content .step strong {
      color: #007bff;
    }
    .ios-modal-content .url-box {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<!-- iOS PWA Notification Banner -->
<div id="ios-notification-banner">
  📱 For notifications, please use Safari browser instead of this home screen app
  <button class="close-banner" onclick="closeBanner()">&times;</button>
</div>

<!-- iOS Instructions Modal -->
<div id="ios-modal">
  <div class="ios-modal-content">
    <h3>🔔 Enable Notifications</h3>
    <p>iOS home screen apps don't support web notifications yet.</p>
    
    <div class="step">
      <strong>Option 1:</strong> Open this website in Safari browser where notifications work perfectly.
    </div>
    
    <div class="step">
      <strong>Option 2:</strong> Copy this URL and paste it in Safari:
      <div class="url-box" id="url-display"></div>
      <button class="btn btn-sm btn-primary mt-2" onclick="copyUrl()">Copy URL</button>
    </div>
    
    <div class="mt-3">
      <button class="btn btn-secondary me-2" onclick="closeModal()">Maybe Later</button>
      <button class="btn btn-primary" onclick="openInNewTab()">Try Opening Safari</button>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="#">Sachin Deep Cleaning</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#services">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="#booking">Booking</a></li>
        <li class="nav-item"><a class="nav-link" href="#reviews">Reviews</a></li>
      </ul>
    </div>
  </div>
</nav>

<section class="hero">
  <div class="container">
    <h1>Residential & Commercial Cleaning Services</h1>
    <p>Serving Gurgaon with Professional Cleaning Solutions</p>
    <a href="#booking" class="btn btn-primary mt-3">Book Now</a>
  </div>
</section>

<section class="services py-5" id="services">
  <div class="container">
    <div class="text-center mb-4">
      <h2>Our Services</h2>
    </div>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            <i class="fas fa-house-user fa-3x mb-3 text-primary"></i>
            <h5 class="card-title">Home Deep Cleaning</h5>
            <p class="card-text">Thorough cleaning of every corner in your home to ensure a spotless and healthy environment.</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            <i class="fas fa-building fa-3x mb-3 text-primary"></i>
            <h5 class="card-title">Office Cleaning</h5>
            <p class="card-text">Professional cleaning services for offices to create a clean and productive workspace.</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            <i class="fas fa-couch fa-3x mb-3 text-primary"></i>
            <h5 class="card-title">Sofa Cleaning</h5>
            <p class="card-text">Deep cleaning and stain removal for sofas to keep your furniture fresh and hygienic.</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            <i class="fas fa-utensils fa-3x mb-3 text-primary"></i>
            <h5 class="card-title">Kitchen Cleaning</h5>
            <p class="card-text">Comprehensive cleaning of kitchen surfaces, appliances, and sinks for a spotless cooking area.</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            <i class="fas fa-carpet fa-3x mb-3 text-primary"></i>
            <h5 class="card-title">Carpet Shampooing</h5>
            <p class="card-text">Deep shampoo cleaning to remove dirt, dust, and allergens from your carpets.</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            <i class="fas fa-bug fa-3x mb-3 text-primary"></i>
            <h5 class="card-title">Pest Control</h5>
            <p class="card-text">Effective pest management to keep your premises safe and pest-free.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="py-5 bg-light" id="booking">
  <div class="container">
    <div class="text-center mb-4">
      <h2>Book a Cleaning Service</h2>
      <p>Fill out the form below to schedule a cleaning</p>
    </div>
    <form id="bookingForm" class="row g-3">
      <div class="col-md-6">
        <input type="text" name="name" class="form-control" placeholder="Your Name" required>
      </div>
      <div class="col-md-6">
        <input type="tel" name="phone" class="form-control" placeholder="Your Phone Number" required>
      </div>
      <!-- === Insert this block AFTER the phone input === -->
<div class="col-md-12">
  <label for="address" class="form-label">Address</label>
  <div class="input-group">
    <input type="text" id="address" name="address" class="form-control" placeholder="Enter your address" required>
    <button type="button" id="getLocation" class="btn btn-outline-secondary" title="Use current location">📍</button>
  </div>
  <small class="text-muted">Click the 📍 button to auto-fill your address (requires permission).</small>
</div>
<!-- === End insert === -->
      <div class="col-md-6">
        <select name="bhk" class="form-select" required>
          <option value="" disabled selected>Select BHK Type</option>
          <option value="1RK">1RK</option>
          <option value="1BHK">1BHK</option>
          <option value="2BHK">2BHK</option>
          <option value="3BHK">3BHK</option>
          <option value="4BHK">4BHK</option>
          <option value="5BHK">5BHK</option>
        </select>
      </div>
      <div class="col-md-6">
        <select name="furnished" class="form-select" required>
          <option value="" disabled selected>Furnishing</option>
          <option value="Furnished">Furnished</option>
          <option value="Non-Furnished">Non-Furnished</option>
        </select>
      </div>

      <!-- Add-ons -->
      <div class="col-12">
        <label class="form-label">Add-on Services (optional)</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input addon" type="checkbox" value="Carpet Cleaning" data-price="500">
          <label class="form-check-label">Carpet Cleaning (+₹500)</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input addon" type="checkbox" value="Fridge Cleaning" data-price="300">
          <label class="form-check-label">Fridge Cleaning (+₹300)</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input addon" type="checkbox" value="Balcony Cleaning" data-price="400">
          <label class="form-check-label">Balcony Cleaning (+₹400)</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input addon" type="checkbox" value="Pest Control" data-price="600">
          <label class="form-check-label">Pest Control (+₹600)</label>
        </div>
      </div>

      <!-- Display Price -->
      <div class="col-12">
        <h5>Estimated Price: ₹<span id="estimatedPrice">0</span></h5>
      </div>

      <input type="hidden" name="price">
      <input type="hidden" name="addons">
      <input type="hidden" name="payment" value="Pay After Work">

      <div class="col-12 text-center">
        <button type="submit" class="btn btn-primary">Submit Booking</button>
      </div>
    </form>

    <!-- Spinner element -->
    <div id="spinner"></div>
  </div>
</section>

<!-- Reviews Section -->
<section id="reviews">
  <div class="container">
    <h2>Customer Reviews</h2>
    <div id="reviewSlider" class="row g-3">
      <!-- Reviews will be injected here -->
    </div>
  </div>
</section>

<footer>
  <div class="container">
    <p>&copy; 2025 Sachin Deep Cleaning. All rights reserved.</p>
  </div>
</footer>

<!-- Right side -->
<a href="tel:+919267905943" class="floating-button call-button" title="Call Now">
  <i class="fas fa-phone-alt"></i>
</a>
<a href="https://wa.me/919267905943?text=Hello%2C%20I%20am%20interested%20in%20Sachin%20Deep%20Cleaning%20Services.%20Please%20get%20in%20touch%E2%80%A6" 
   class="floating-button whatsapp-button"
   target="_blank">
  <i class="fab fa-whatsapp"></i> 
</a>

<!-- Left side -->
<button id="installBtn" title="Download App">
  <i class="fas fa-download"></i>
</button>
<button class="notification-button" id="notifyBtn" title="Enable Notifications">
  <i class="fas fa-bell"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Pricing configuration
const pricing = {
  "1RK": { "Furnished": 2000, "Non-Furnished": 1500 },
  "1BHK": { "Furnished": 2500, "Non-Furnished": 2000 },
  "2BHK": { "Furnished": 4500, "Non-Furnished": 4000 },
  "3BHK": { "Furnished": 5500, "Non-Furnished": 5000 },
  "4BHK": { "Furnished": 7000, "Non-Furnished": 6000 },
  "5BHK": { "Furnished": 10000, "Non-Furnished": 8500 }
};

function calculateTotal() {
  const bhk = document.querySelector('[name="bhk"]').value;
  const furnished = document.querySelector('[name="furnished"]').value;

  let total = pricing[bhk]?.[furnished] || 0;
  const addonsDetails = [];

  document.querySelectorAll('.addon:checked').forEach(addon => {
    const price = parseInt(addon.dataset.price);
    total += price;
    addonsDetails.push(`${addon.value}: ₹${price}`);
  });

  document.getElementById("estimatedPrice").innerText = total;
  document.querySelector('[name="price"]').value = total;
  document.querySelector('[name="addons"]').value = addonsDetails.join(", ");
}

// Initialize price calculation
window.addEventListener('DOMContentLoaded', calculateTotal);
document.querySelector('[name="bhk"]').addEventListener("change", calculateTotal);
document.querySelector('[name="furnished"]').addEventListener("change", calculateTotal);
document.querySelectorAll('.addon').forEach(el => el.addEventListener("change", calculateTotal));

// Reviews data
const reviewsData = [
  {name: "Amit Sharma", gender: "male", location: "South City 1", text: "Amazing cleaning service. Highly recommended!"},
  {name: "Priya Verma", gender: "female", location: "Sushant Lok", text: "Very professional and punctual team."},
  {name: "Rohit Kumar", gender: "male", location: "Sector 14", text: "My home looks spotless after their cleaning."},
  {name: "Neha Singh", gender: "female", location: "Sector 49", text: "Friendly staff and thorough cleaning."},
  {name: "Vikram Patel", gender: "male", location: "Golf Course Road", text: "Affordable and reliable service."},
  {name: "Simran Kaur", gender: "female", location: "Palam Vihar", text: "Great attention to detail."},
  {name: "Rahul Mehta", gender: "male", location: "Sector 56", text: "They transformed my office space."},
  {name: "Pooja Gupta", gender: "female", location: "DLF Phase 1", text: "Excellent customer support."},
  {name: "Sandeep Singh", gender: "male", location: "Sector 45", text: "Very satisfied with the results."},
  {name: "Anjali Joshi", gender: "female", location: "Sector 22", text: "Will definitely book again."}
];

function getInitials(name) {
  return name.split(' ').map(n => n[0]).join('').toUpperCase();
}

function createStarRatingHTML() {
  return '<i class="fas fa-star"></i>'.repeat(5);
}

function createReviewCard(review) {
  return `
    <div class="col-md-4 mb-4">
      <div class="review-card p-3 border rounded shadow-sm bg-white">
        <div class="review-header d-flex align-items-center mb-3">
          <div class="avatar-placeholder me-3">${getInitials(review.name)}</div>
          <div>
            <p class="reviewer-name mb-0 fw-bold">${review.name}</p>
            <small class="reviewer-location text-muted">${review.location}</small>
          </div>
        </div>
        <p class="review-text fst-italic">"${review.text}"</p>
        <div class="star-rating text-warning">${createStarRatingHTML()}</div>
      </div>
    </div>
  `;
}

let currentIndex = 0;
const reviewsPerSlide = 3;
const reviewContainer = document.getElementById('reviewSlider');

function renderReviews() {
  reviewContainer.innerHTML = '';
  for(let i = 0; i < reviewsPerSlide; i++) {
    const idx = (currentIndex + i) % reviewsData.length;
    reviewContainer.innerHTML += createReviewCard(reviewsData[idx]);
  }
}

function slideReviews() {
  currentIndex = (currentIndex + reviewsPerSlide) % reviewsData.length;
  renderReviews();
}

// Initialize reviews
document.addEventListener('DOMContentLoaded', () => {
  renderReviews();
  setInterval(slideReviews, 3000);
  
  // Show iOS PWA notification banner if applicable
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true;
  const isIOSPWA = isIOS && isPWA;
  
  if (isIOSPWA && !localStorage.getItem('ios_banner_dismissed')) {
    setTimeout(() => {
      document.getElementById('ios-notification-banner').classList.add('show');
    }, 2000);
  }
});

// iOS banner functions
function closeBanner() {
  document.getElementById('ios-notification-banner').classList.remove('show');
  localStorage.setItem('ios_banner_dismissed', 'true');
}

function closeModal() {
  document.getElementById('ios-modal').classList.remove('show');
  localStorage.setItem('ios_notification_dismissed', 'true');
  document.getElementById('notifyBtn').style.display = 'none';
}

function copyUrl() {
  const url = window.location.href;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(url).then(() => {
      alert('URL copied! Now paste it in Safari browser.');
    }).catch(() => {
      // Fallback - show the URL for manual copying
      prompt('Copy this URL manually:', url);
    });
  } else {
    // Fallback for older browsers
    prompt('Copy this URL manually:', url);
  }
}

function openInNewTab() {
  // This will try to open in a new tab, which might open Safari on iOS
  const newWindow = window.open(window.location.href, '_blank');
  if (!newWindow) {
    // If popup blocked, show the URL to copy
    copyUrl();
  } else {
    closeModal();
  }
}

  // --- Geolocation + reverse-geocoding (put this BEFORE the submit handler) ---
document.addEventListener('DOMContentLoaded', () => {
  const getLocationBtn = document.getElementById("getLocation");
  if (!getLocationBtn) return; // button not present, skip

  getLocationBtn.addEventListener("click", async function () {
    if (!navigator.geolocation) {
      alert("Geolocation not supported by your browser.");
      return;
    }

    const btn = getLocationBtn;
    btn.disabled = true;
    const origHTML = btn.innerHTML;
    btn.innerHTML = "Locating…";

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      try {
        // Always use OpenStreetMap Nominatim
        const nomUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
        const resp = await fetch(nomUrl, {
          headers: {
            'Accept-Language': 'en', // optional: return address in English
            'User-Agent': 'SachinDeepCleaning/1.0' // polite for OSM API
          }
        });
        const data = await resp.json();
        if (data && data.display_name) {
          document.getElementById("address").value = data.display_name;
        } else {
          throw new Error("No address found from OSM");
        }
      } catch (err) {
        console.error(err);
        alert("Unable to convert location to address. Please enter address manually.");
      } finally {
        btn.disabled = false;
        btn.innerHTML = origHTML;
      }

    }, (err) => {
      btn.disabled = false;
      btn.innerHTML = origHTML;
      switch (err.code) {
        case err.PERMISSION_DENIED:
          alert("Location permission denied. Please allow location access or enter address manually.");
          break;
        case err.POSITION_UNAVAILABLE:
          alert("Location unavailable. Try again.");
          break;
        case err.TIMEOUT:
          alert("Location timed out. Try again.");
          break;
        default:
          alert("Unable to get location.");
      }
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  });
});
// Booking form submission handler
document.getElementById("bookingForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const spinner = document.getElementById("spinner");
  spinner.style.display = "block";

  const form = e.target;
  const formData = new FormData(form);
  const data = {};
  formData.forEach((value, key) => {
    data[key] = value;
  });

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbxCl4QKzA7cytjsylc821h0DZIATSp4FGD2JQVNDzdOwRK1y8VpvSoxg3Z5g52qp7uA/exec", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(data).toString()
    });

    const text = await response.text();

    if (response.ok && text.trim() === "Success") {
      alert("Booking submitted successfully! Thank you.");
      form.reset();
      calculateTotal();
    } else {
      alert("Failed to submit booking. Please try again.");
      console.error("Response:", text);
    }
  } catch (err) {
    alert("Error submitting booking: " + err.message);
    console.error(err);
  } finally {
    spinner.style.display = "none";
  }
});

// Service Worker and PWA functionality
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => {
        console.log('Service Worker registered:', reg.scope);
      })
      .catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
  });
}

let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'flex';
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  try {
    deferredPrompt.prompt();
    const choiceResult = await deferredPrompt.userChoice;
    if (choiceResult.outcome === 'accepted') {
      console.log('User accepted the app install');
    }
  } catch (err) {
    console.warn('Error during app install:', err);
  } finally {
    deferredPrompt = null;
    installBtn.style.display = 'none';
  }
});

window.addEventListener('appinstalled', (evt) => {
  console.log('App was installed');
  installBtn.style.display = 'none';
});

// OneSignal notification handling - Enhanced for iOS PWA
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  const notifyBtn = document.getElementById("notifyBtn");

  if (notifyBtn) {
    notifyBtn.addEventListener("click", async () => {
      try {
        // Detect platform
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true;
        const isIOSPWA = isIOS && isPWA;

        if (isIOSPWA) {
          // iOS PWA - Show modal with instructions
          document.getElementById('url-display').textContent = window.location.href;
          document.getElementById('ios-modal').classList.add('show');
          return;
        }

        if (!('Notification' in window)) {
          alert("This browser doesn't support notifications.");
          return;
        }

        // Try OneSignal first
        try {
          const permission = await OneSignal.Notifications.requestPermission();
          if (permission) {
            alert("Notifications enabled! You'll receive updates about our cleaning services.");
            notifyBtn.style.display = 'none';
            return;
          }
        } catch (oneSignalErr) {
          console.warn('OneSignal permission error:', oneSignalErr);
        }

        // Fallback to browser's native notification API
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          new Notification('Sachin Deep Cleaning', {
            body: 'Updates enabled! We\'ll notify you about cleaning services and offers.',
            icon: '/icons/apple-touch-icon-180x180.png',
            tag: 'cleaning-service',
            requireInteraction: true
          });
          notifyBtn.style.display = 'none';
        } else {
          alert("Please enable notifications to stay updated with our services.");
        }

      } catch (err) {
        console.warn('Notification error:', err);
        alert("Unable to enable notifications at this time.");
      }
    });

    // Check if should hide button for iOS PWA users who dismissed
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                  window.navigator.standalone === true;
    const isIOSPWA = isIOS && isPWA;
    
    if (isIOSPWA && localStorage.getItem('ios_notification_dismissed') === 'true') {
      notifyBtn.style.display = 'none';
    }
  }
});
</script>

</body>
</html>
